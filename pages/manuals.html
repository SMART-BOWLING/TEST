<!-- pages/manuals.html -->

<!-- Экран загрузки -->
<div class="loading-screen" id="loadingScreen">
    <div class="logo-wrapper">
        <div class="glow-ring"></div>
        <img src="https://i.postimg.cc/wjGzSY92/1.png" alt="Loading Logo">
    </div>
</div>

<!-- Шапка -->
<header>
    <div class="logo" onclick="goBack()">
        <img src="https://i.postimg.cc/wjGzSY92/1.png" alt="Logo">
    </div>
    <div class="site-name">MANUALS</div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Поиск детали">
        <i class="fa-solid fa-magnifying-glass"></i>
    </div>
</header>

<!-- Контейнер для контента -->
<div id="manualContainer"></div>

<!-- Кнопки поиска и навигации -->
<div class="search-nav-bottom" id="searchNav">
    <button onclick="window.prevResult?.()"><i class="fa-solid fa-chevron-left"></i></button>
    <button id="clearSearchBtn" onclick="window.clearSearch?.()"><i class="fa-solid fa-times"></i></button>
    <button onclick="window.nextResult?.()"><i class="fa-solid fa-chevron-right"></i></button>
</div>

<!-- Левая кнопка (магазин) -->
<div class="shop-fab-left" onclick="window.openShopSearch?.()">
    <i class="fa-solid fa-magnifying-glass"></i>
</div>

<!-- Правая кнопка (назад) -->
<div class="shop-fab-right" onclick="goBack()">
    <i class="fa-solid fa-arrow-left"></i>
</div>

<style>
    /* Все ваши стили без изменений */
    /* ... скопируйте сюда все стили из исходного manuals.html ... */
</style>

<!-- ВЕСЬ СКРИПТ ТЕПЕРЬ ЗДЕСЬ, БЕЗ ОБЁРТОК -->
<script>
    (function() {
        // Копируем весь ваш код из <script> сюда, но с небольшими изменениями:
        // 1. Все функции, вызываемые из onclick, делаем глобальными через window.
        // 2. Добавляем обработку ошибок.

        const API_URL = "https://script.google.com/macros/s/AKfycbySUf3xM0QvtI1tQ8YYzNnmHfzTnPFFATw7rs0sv3LMAdoWvoLiKiYEwTWtrnDOv5B5tg/exec";

        let manualsData = [];
        let stockData = {};
        let searchResults = [];
        let currentIndex = 0;

        const searchNav = document.getElementById("searchNav");
        const manualContainer = document.getElementById("manualContainer");
        const searchInput = document.getElementById("searchInput");
        const loadingScreen = document.getElementById("loadingScreen");

        // Глобальные функции для onclick
        window.openShopSearch = function() {
            const partNumber = prompt("Введите номер детали:", "");
            if (partNumber && partNumber.trim()) {
                const cleanNumber = partNumber.replace(/-/g, '');
                const form = document.createElement('form');
                form.method = 'get';
                form.action = 'https://shop.bowlingvision.com/catalogue/results.aspx';
                form.style.display = 'none';
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'search';
                input.value = cleanNumber;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
                setTimeout(() => document.body.removeChild(form), 1000);
            }
        };

        window.clearSearch = function() {
            searchInput.value = "";
            searchResults = [];
            currentIndex = 0;
            document.querySelectorAll(".search-highlight,.active-highlight").forEach(el => 
                el.classList.remove("search-highlight", "active-highlight")
            );
            renderManualGroups();
            searchNav.style.display = "none";
        };

        window.nextResult = function() {
            if (!searchResults.length) return;
            searchResults[currentIndex].classList.remove("active-highlight");
            currentIndex = (currentIndex + 1) % searchResults.length;
            searchResults[currentIndex].classList.add("active-highlight");
            searchResults[currentIndex].scrollIntoView({ behavior: "smooth", block: "center" });
        };

        window.prevResult = function() {
            if (!searchResults.length) return;
            searchResults[currentIndex].classList.remove("active-highlight");
            currentIndex = (currentIndex - 1 + searchResults.length) % searchResults.length;
            searchResults[currentIndex].classList.add("active-highlight");
            searchResults[currentIndex].scrollIntoView({ behavior: "smooth", block: "center" });
        };

        // Вспомогательные функции (оставляем как есть)
        function parseCompositeParts(partString) {
            const result = [];
            const regex = /\(([^)]+)\)\s+([\d-]+)/g;
            let match;
            while ((match = regex.exec(partString)) !== null) {
                result.push({ code: match[1].trim(), number: match[2].trim() });
            }
            return result;
        }

        function extractSingleCode(partString) {
            const regex = /^\(([^)]+)\)\s+([\d-]+)$/;
            const match = partString.match(regex);
            return match ? { code: match[1].trim(), number: match[2].trim() } : null;
        }

        function isCompositePart(partString) {
            const matches = partString.match(/\([^)]+\)\s+[\d-]+/g);
            return matches && matches.length > 1;
        }

        function renderManualGroups() {
            manualContainer.innerHTML = "";
            [...new Set(manualsData.map(m => m.name))].forEach(name => {
                const b = document.createElement("button");
                b.className = "start-btn";
                b.innerHTML = `<i class="fa-solid fa-book-open"></i><span>${name}</span>`;
                b.onclick = () => renderManualsByName(name);
                manualContainer.appendChild(b);
            });
            searchInput.value = "";
            searchResults = [];
            currentIndex = 0;
            searchNav.style.display = "none";
        }

        function renderManualsByName(name) {
            manualContainer.innerHTML = "";
            manualsData.filter(m => m.name === name).forEach(manual => {
                const block = document.createElement("div");
                block.className = "block";
                block.innerHTML = `
                    <div class="manual-label">${manual.name}</div>
                    <img class="top-image clickable-image" src="${manual.image}">
                    <div class="buttons-container"></div>
                `;
                const cont = block.querySelector(".buttons-container");
                const image = block.querySelector(".clickable-image");
                image.onclick = () => cont.style.display = cont.style.display === "flex" ? "none" : "flex";

                manual.parts.forEach((part, index) => {
                    const singleCode = extractSingleCode(part);
                    if (singleCode) {
                        createPartButton(cont, singleCode.number, singleCode.code, image);
                    } else if (isCompositePart(part)) {
                        parseCompositeParts(part).forEach(p => createPartButton(cont, p.number, p.code, image));
                    } else {
                        createPartButton(cont, part, (index + 1).toString(), image);
                    }
                });
                manualContainer.appendChild(block);
            });
        }

        function createPartButton(container, partNumber, label, image) {
            const btn = document.createElement("div");
            btn.className = "btn";
            btn.innerHTML = `<span>${label}</span><span class="detail-number">${partNumber}</span>`;
            btn.onclick = (e) => {
                const targetDetail = e.target.closest(".detail-number");
                if (targetDetail) {
                    e.stopPropagation();
                    const originalText = targetDetail.textContent;
                    navigator.clipboard.writeText(originalText).then(() => {
                        targetDetail.textContent = "Скопировано!";
                        setTimeout(() => targetDetail.textContent = originalText, 1200);
                    });
                    return;
                }
                toggleDetail(btn);
                if (image) {
                    image.classList.add("highlight-image");
                    setTimeout(() => image.classList.remove("highlight-image"), 800);
                }
            };
            container.appendChild(btn);
        }

        function toggleDetail(btn) {
            const nextEl = btn.nextElementSibling;
            if (nextEl && nextEl.classList.contains("detail-info")) {
                nextEl.remove();
                btn.classList.remove("active-detail");
                return;
            }
            const container = btn.parentElement;
            container.querySelectorAll(".detail-info").forEach(el => el.remove());
            container.querySelectorAll(".btn").forEach(b => b.classList.remove("active-detail"));

            const part = btn.querySelector(".detail-number").textContent;
            const info = document.createElement("div");
            info.className = "detail-info";
            let clubDataHtml = "";
            ["BB", "KH", "SKYMALL", "STORE"].forEach(k => {
                const count = stockData[part]?.[k] ?? 0;
                clubDataHtml += `<div class="club-row"><span>${k}</span><span class="${count === 0 ? 'count-zero' : 'count-positive'}">${count} шт.</span></div>`;
            });
            info.innerHTML = clubDataHtml;
            btn.after(info);
            btn.classList.add("active-detail");
            setTimeout(() => info.classList.add("open"), 10);
        }

        // Поиск
        searchInput.oninput = function(e) {
            const v = e.target.value.trim();
            searchResults = [];
            currentIndex = 0;
            document.querySelectorAll(".search-highlight,.active-highlight").forEach(el => 
                el.classList.remove("search-highlight", "active-highlight")
            );
            if (!v) {
                renderManualGroups();
                return;
            }
            searchNav.style.display = "flex";
            manualsData.forEach(m => {
                const checkPart = (part) => {
                    const sc = extractSingleCode(part);
                    if (sc && sc.number.includes(v)) return true;
                    if (isCompositePart(part)) return parseCompositeParts(part).some(p => p.number.includes(v));
                    return part.includes(v);
                };
                if (m.parts.some(checkPart)) {
                    renderManualsByName(m.name);
                    setTimeout(() => {
                        document.querySelectorAll(".detail-number").forEach(el => {
                            if (el.textContent.includes(v)) {
                                el.classList.add("search-highlight");
                                el.closest('.buttons-container').style.display = "flex"; // убедимся, что контейнер открыт
                                searchResults.push(el);
                            }
                        });
                        if (searchResults[0]) {
                            searchResults[0].classList.add("active-highlight");
                            searchResults[0].scrollIntoView({ behavior: "smooth", block: "center" });
                        }
                    }, 100);
                }
            });
        };

        // Загрузка данных
        async function loadManuals() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                const data = await res.json();
                manualsData = data.manuals;
                stockData = data.stock;
                renderManualGroups();
                loadingScreen.classList.add('fade-out');
            } catch (error) {
                console.error('Ошибка загрузки manuals:', error);
                loadingScreen.classList.add('fade-out');
                manualContainer.innerHTML = `<div class="error-message">Ошибка загрузки данных: ${error.message}</div>`;
            }
        }

        // Запуск
        loadManuals();

        // Защита от двойного тапа (оставляем)
        let lastTouchEnd = 0;
        document.addEventListener("touchend", function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, false);
    })();
</script>