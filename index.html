<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MANUALS</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: #ffffff;
  color: #1f2937;
  padding-top: 70px;
}

header {
  background-color: #1f2937;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  position: fixed;
  top:0; left:0; right:0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  z-index:1000;
}

.logo img {
  width:40px;
  height:40px;
  object-fit:cover;
  cursor: pointer;
}

.site-name {
  flex:1;
  text-align:center;
  font-size:18px;
  font-weight:bold;
}

.search-container {
  position:relative;
}

.search-container input {
  padding:6px 30px 6px 10px;
  border-radius:6px;
  border:none;
  font-size:16px;
  width:180px;
}

.search-container i {
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  color:#374151;
}

.block { margin-bottom:10px; }

.top-image {
  width:100%;
  max-height:300px;
  object-fit:cover;
}

.toggle-btn {
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:600;
  background:#1f2937;
  color:#fff;
  border:none;
  cursor:pointer;
  margin:8px 0;
  text-align:left;
}

.buttons-container {
  display:none;
  flex-direction:column;
}

.btn {
  display:flex;
  justify-content:space-between;
  padding:12px 16px;
  border:1px solid #ddd;
  background:#fff;
  cursor:pointer;
  margin-bottom:4px;
}

.btn:hover { background:#f9fafb; }

.highlight {
  background:#ffe4e6 !important;
  border-color:#dc143c !important;
}

.copy-success {
  background:#1f2937 !important;
  color:white !important;
}

.detail-info {
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:0.4s;
  background:#fff;
  border-left:3px solid #dc143c;
  margin-bottom:8px;
}

.detail-info.open {
  max-height:500px;
  opacity:1;
}

.club-row {
  display:flex;
  justify-content:space-between;
  padding:10px 16px;
  border-top:1px solid #eee;
}

.count-zero { color:#dc143c; }
.count-positive { color:#16a34a; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="https://i.postimg.cc/wjGzSY92/1.png">
  </div>
  <div class="site-name">MANUALS</div>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Поиск детали">
    <i class="fa-solid fa-magnifying-glass"></i>
  </div>
</header>

<div id="manualContainer"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbySUf3xM0QvtI1tQ8YYzNnmHfzTnPFFATw7rs0sv3LMAdoWvoLiKiYEwTWtrnDOv5B5tg/exec";

let manualsData = [];
let stockData = {};

async function loadManuals(){
  const response = await fetch(API_URL);
  const data = await response.json();

  manualsData = data.manuals;
  stockData = data.stock;

  renderManualGroups();
}

function renderManualGroups(filter=""){
  const container = document.getElementById("manualContainer");
  container.innerHTML = "";

  const uniqueNames = [...new Set(manualsData.map(m => m.name))];

  uniqueNames.forEach(name => {
    const relatedManuals = manualsData.filter(m => m.name === name);

    if(filter){
      const hasMatch = relatedManuals.some(m => m.parts.some(p => p.includes(filter)));
      if(!hasMatch) return;
    }

    const btn = document.createElement("button");
    btn.className = "toggle-btn";
    btn.textContent = name;

    btn.addEventListener("click", () => renderManualsByName(name, filter));
    container.appendChild(btn);
  });
}

function renderManualsByName(name, filter=""){
  const container = document.getElementById("manualContainer");
  container.innerHTML = "";

  const filtered = manualsData.filter(m => m.name === name);

  filtered.forEach(manual => {
    const block = document.createElement("div");
    block.className = "block";

    block.innerHTML = `
      <img class="top-image" src="${manual.image}">
      <button class="toggle-btn">${manual.name}</button>
      <div class="buttons-container"></div>
    `;

    const btnContainer = block.querySelector(".buttons-container");

    manual.parts.forEach((part,i)=>{
      if(filter && !part.includes(filter)) return;

      const btn=document.createElement("div");
      btn.className="btn";

      btn.innerHTML=`
        <span>${i+1}</span>
        <span class="detail-number">${part}</span>
      `;

      btn.addEventListener("click",(e)=>{
        if(e.target.classList.contains("detail-number")){
          copyToClipboard(part, e.target);
          e.stopPropagation(); // НЕ открываем список при клике на текст номера
          return;
        }
        toggleDetail(btn);
      });

      btnContainer.appendChild(btn);
    });

    block.querySelector(".toggle-btn")
      .addEventListener("click",()=>{
        btnContainer.style.display = btnContainer.style.display==="flex"?"none":"flex";
      });

    container.appendChild(block);
  });

  const logo = document.querySelector(".logo");
  logo.addEventListener("click", ()=>renderManualGroups(filter));
}

function toggleDetail(button){
  if(button.nextElementSibling &&
     button.nextElementSibling.classList.contains("detail-info")){
    button.nextElementSibling.remove();
    return;
  }

  const partNumber = button.querySelector(".detail-number").textContent;
  const info=document.createElement("div");
  info.className="detail-info";

  const clubs = [
    { key:"BB", name:"BLOCKBUSTER" },
    { key:"KH", name:"LUCKY STRIKE KH" },
    { key:"SKYMALL", name:"SKYMALL" },
    { key:"STORE", name:"STORE" }
  ];

  clubs.forEach(club=>{
    const count = stockData[partNumber]?.[club.key] ?? 0;
    info.innerHTML+=`
      <div class="club-row">
        <span>${club.name}</span>
        <span class="${count===0?'count-zero':'count-positive'}">
          ${count} шт.
        </span>
      </div>
    `;
  });

  button.after(info);
  setTimeout(()=>info.classList.add("open"),10);
}

async function copyToClipboard(text,el){
  await navigator.clipboard.writeText(text);
  const original = el.innerHTML;
  el.innerHTML="✓ Скопировано!";
  setTimeout(()=>el.innerHTML=original,1000);
}

// поиск по инпуту
document.getElementById("searchInput").addEventListener("input",(e)=>{
  const val = e.target.value.trim();
  if(val===""){
    renderManualGroups();
  }else{
    renderManualGroups(val);
  }
});

loadManuals();
</script>
</body>
</html>